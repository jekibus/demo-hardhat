"use strict";function e(e,n,t,r,a,u,i){try{var o=e[u](i);var s=o.value}catch(e){t(e);return}if(o.done){n(s)}else{Promise.resolve(s).then(r,a)}}function n(n){return function(){var t=this,r=arguments;return new Promise(function(a,u){var i=n.apply(t,r);function o(n){e(i,a,u,o,s,"next",n)}function s(n){e(i,a,u,o,s,"throw",n)}o(undefined)})}}function t(e,n){var t,r,a,u,i={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]};return(u={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol==="function"&&(u[Symbol.iterator]=function(){return this}),u);function o(e){return function(n){return s([e,n])}}function s(u){if(t)throw new TypeError("Generator is already executing.");while(i)try{if(t=1,r&&(a=u[0]&2?r["return"]:u[0]?r["throw"]||((a=r["return"])&&a.call(r),0):r.next)&&!(a=a.call(r,u[1])).done)return a;if(r=0,a)u=[u[0]&2,a.value];switch(u[0]){case 0:case 1:a=u;break;case 4:i.label++;return{value:u[1],done:false};case 5:i.label++;r=u[1];u=[0];continue;case 7:u=i.ops.pop();i.trys.pop();continue;default:if(!(a=i.trys,a=a.length>0&&a[a.length-1])&&(u[0]===6||u[0]===2)){i=0;continue}if(u[0]===3&&(!a||u[1]>a[0]&&u[1]<a[3])){i.label=u[1];break}if(u[0]===6&&i.label<a[1]){i.label=a[1];a=u;break}if(a&&i.label<a[2]){i.label=a[2];i.ops.push(u);break}if(a[2])i.ops.pop();i.trys.pop();continue}u=n.call(e,i)}catch(e){u=[6,e];r=0}finally{t=a=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:true}}}var r=Object.create;var a=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var i=Object.getOwnPropertyNames;var o=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty;var c=function(e,n,t,r){var o=true,c=false,l=undefined;if(n&&typeof n=="object"||typeof n=="function")try{var p=function(){var i=d.value;!s.call(e,i)&&i!==t&&a(e,i,{get:function(){return n[i]},enumerable:!(r=u(n,i))||r.enumerable})};for(var f=i(n)[Symbol.iterator](),d;!(o=(d=f.next()).done);o=true)p()}catch(e){c=true;l=e}finally{try{if(!o&&f.return!=null){f.return()}}finally{if(c){throw l}}}return e};var l=function(e,n,t){return t=e!=null?r(o(e)):{},c(n||!e||!e.__esModule?a(t,"default",{value:e,enumerable:!0}):t,e)};var p=l(require("@whiskeysockets/baileys")),f=require("http"),d=l(require("url")),h=l(require("better-sqlite3")),v=process.env.USE_DB,y;console.log({USE_DB:v});v&&(y=new h.default("./db/data.sqlite"),y.pragma("journal_mode = WAL"));var w;function b(){return g.apply(this,arguments)}function g(){g=n(function(){var e,r,a;return t(this,function(u){switch(u.label){case 0:return[4,(0,p.useMultiFileAuthState)("auth_info_baileys")];case 1:e=u.sent(),r=e.state,a=e.saveCreds;w=(0,p.default)({printQRInTerminal:!0,auth:r,browser:p.Browsers.macOS("Desktop")}),w.ev.on("creds.update",a),w.ev.on("connection.update",function(e){var n=e.connection,t=e.lastDisconnect;if(n==="close"){var r,a;var u=(t===null||t===void 0?void 0:(a=t.error)===null||a===void 0?void 0:(r=a.output)===null||r===void 0?void 0:r.statusCode)!==p.DisconnectReason.loggedOut;console.log("connection closed due to ",t===null||t===void 0?void 0:t.error,", reconnecting ",u),u&&b()}else n==="open"&&console.log("opened connection")}),w.ev.on("messages.upsert",function(){var e=n(function(e){return t(this,function(e){return[2]})});return function(n){return e.apply(this,arguments)}}()),w.ev.on("messages.update",function(){var e=n(function(e){return t(this,function(n){S(e);return[2]})});return function(n){return e.apply(this,arguments)}}());return[2]}})});return g.apply(this,arguments)}function m(e,n){return w.sendMessage(e,{text:n})}function S(e){return O.apply(this,arguments)}function O(){O=n(function(e){var n,r,a,u,i,o;return t(this,function(t){if(e.length===0||!v)return[2];r=e[0];if((r===null||r===void 0?void 0:(n=r.key)===null||n===void 0?void 0:n.fromMe)==!0){;u=r.key.id,i=(a=r.update)===null||a===void 0?void 0:a.status,o=y.prepare("SELECT id, wastatus FROM presences WHERE wamid = ?").get(u);if(o){if(o.wastatus&&parseInt(o.wastatus)>i)return[2];y.prepare("UPDATE presences SET wastatus = ? WHERE id = ?").run(i,o.id)}}return[2]})});return O.apply(this,arguments)}function E(e,n){return k.apply(this,arguments)}function k(){k=n(function(e,n){var r;return t(this,function(t){v&&e&&(n===null||n===void 0?void 0:(r=n.key)===null||r===void 0?void 0:r.id)&&y.prepare("UPDATE presences SET wamid = ?, wastatus = ? WHERE id = ?").run(n.key.id,1,e);return[2]})});return k.apply(this,arguments)}function N(e){return T.apply(this,arguments)}function T(){T=n(function(e){return t(this,function(n){return[2,y.prepare("SELECT p.*, u.name, u.role, u.picphone, u.phone, u.iswa, u2.name as byname, l.name as lname FROM presences p JOIN users u ON u.id = p.user_id JOIN users u2 ON u2.id = p.pby JOIN levels l on l.id = p.level_id WHERE p.id = ?").get(e)]})});return T.apply(this,arguments)}function P(e){switch(e){case"H":return"Hadir";case"S":return"Sakit";case"I":return"Izin";case"A":return"Tanpa Keterangan";default:return"-"}}function j(e){var n="",t=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],r=new Date(e.created_at),a="".concat(r.getHours().toString().padStart(2,"0"),":").concat(r.getMinutes().toString().padStart(2,"0"),":").concat(r.getSeconds().toString().padStart(2,"0"));return n+=e.role==="SISWA"?"Siswa":"Sivitas",n+=" yang bernama: \n",n+=e.name+(e.role==="SISWA"?" \nKelas ".concat(e.lname):"")+" \n",n+=e.pstatus==="H"?"Hadir pada jam ".concat(a," \n"):"Tidak hadir dikarenakan ".concat(P(e.pstatus)," \n"),n+="Dilaporkan oleh ".concat(e.byname," \n"),n+="".concat(r.getDate()," ").concat(t[r.getMonth()]," ").concat(r.getFullYear()," \n"),n+="SMK Pst. Al-Huda Bojonggambir.",n}function D(e){var n;return e.iswa&&e.picphone&&(n="".concat(e.picphone,"@s.whatsapp.net")),n}function H(e){return new Promise(function(n){var t=[],r;e.on("data",function(e){t.push(e)}).on("end",function(){r=Buffer.concat(t).toString(),n(r)})})}function J(e,n){return M.apply(this,arguments)}function M(){M=n(function(e,n){var r,a,u,i,o,s,c,l,p,f,h;return t(this,function(t){switch(t.label){case 0:if(!e.url)return[3,10];r=new d.URL("http://".concat(e.headers.host).concat(e.url));if(!(r.pathname==="/messages"&&e.method==="POST"&&v))return[3,6];return[4,H(e)];case 1:a=t.sent();if(!a)return[3,5];u=JSON.parse(a).id;if(!u)return[3,5];return[4,N(u)];case 2:i=t.sent();if(!i)return[3,5];o=j(i),s=D(i);if(!s)return[3,5];return[4,m(s,o)];case 3:c=t.sent();return[4,E(u,c)];case 4:t.sent();t.label=5;case 5:return[3,10];case 6:if(!(r.pathname==="/instant-messages"&&e.method==="POST"))return[3,9];return[4,H(e)];case 7:l=t.sent();if(!l)throw new Error("No Body");p=JSON.parse(l),f=p.msg,h=p.to;if(!h||!f)throw new Error("Invalid body keys");if(h.slice(0,2)!=="62")throw new Error("Number must start with 62");return[4,m("".concat(h,"@s.whatsapp.net"),f)];case 8:t.sent();return[3,10];case 9:throw new Error("Not Found");case 10:n.writeHead(200,{"Content-Type":"application/json"}),n.end(JSON.stringify({data:!0}));return[2]}})});return M.apply(this,arguments)}b();var A=(0,f.createServer)();A.on("request",function(){var e=n(function(e,n){var r;return t(this,function(t){switch(t.label){case 0:t.trys.push([0,2,,3]);return[4,J(e,n)];case 1:t.sent();return[3,3];case 2:r=t.sent();n.writeHead(400,{"Content-Type":"application/json"}),n.end(JSON.stringify({error:!0,message:r.message}));return[3,3];case 3:return[2]}})});return function(n,t){return e.apply(this,arguments)}}());A.listen(9001,"0.0.0.0");A.on("listening",function(){console.log("Server is running on ".concat(JSON.stringify(A.address())))});